<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
        }
        .status-container {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .results-container {
            display: none;
            margin-top: 2rem;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-update {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .ticker-card {
            margin-bottom: 1rem;
        }
        .sentiment-positive { color: #28a745; }
        .sentiment-negative { color: #dc3545; }
        .sentiment-neutral { color: #6c757d; }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1 class="mb-4">Market Analysis Dashboards</h1>
        
        <div class="d-grid gap-2">
            <button id="startAnalysis" class="btn btn-primary btn-lg">
                Start Market Analysis
            </button>
        </div>

        <div id="statusContainer" class="status-container">
            <h3>Status Updates</h3>
            <div id="statusUpdates"></div>
            <div class="progress mt-3" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsContainer" class="results-container">
            <h3>Analysis Results</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4>Top Positive Sentiment Stocks</h4>
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4>Predicted Price Changes</h4>
                        <canvas id="predictionsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h4>Detailed Analysis</h4>
                <div id="detailedResults" class="row"></div>
            </div>
        </div>
    </div>

    <script>
        let analysisInProgress = false;

        function addStatusUpdate(message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-update';
            statusDiv.textContent = message;
            document.getElementById('statusUpdates').appendChild(statusDiv);
        }

        function updateProgress(percent) {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${percent}%`;
            progressBar.parentElement.style.display = 'flex';
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.style.display = 'block';

            // Process correlations and predictions
            const correlations = data.analysis.correlations;
            const predictions = data.analysis.predictions;

            // Prepare data for sentiment chart
            const sentimentData = Object.entries(correlations)
                .map(([ticker, articles]) => ({
                    ticker,
                    avgSentiment: articles.reduce((sum, a) => sum + a.sentiment, 0) / articles.length
                }))
                .sort((a, b) => b.avgSentiment - a.avgSentiment)
                .slice(0, 10);

            // Create sentiment chart
            new Chart(document.getElementById('sentimentChart'), {
                type: 'bar',
                data: {
                    labels: sentimentData.map(d => d.ticker),
                    datasets: [{
                        label: 'Average Sentiment',
                        data: sentimentData.map(d => d.avgSentiment),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Prepare data for predictions chart
            const predictionsData = Object.entries(predictions)
                .map(([ticker, data]) => ({
                    ticker,
                    change: data.predicted_change_percent
                }))
                .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
                .slice(0, 10);

            // Create predictions chart
            new Chart(document.getElementById('predictionsChart'), {
                type: 'bar',
                data: {
                    labels: predictionsData.map(d => d.ticker),
                    datasets: [{
                        label: 'Predicted Change %',
                        data: predictionsData.map(d => d.change),
                        backgroundColor: d => d > 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Display detailed results
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = '';

            Object.entries(correlations)
                .filter(([ticker]) => predictions[ticker])
                .forEach(([ticker, articles]) => {
                    const prediction = predictions[ticker];
                    const avgSentiment = articles.reduce((sum, a) => sum + a.sentiment, 0) / articles.length;
                    
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 ticker-card';
                    card.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${ticker}</h5>
                                <p class="card-text">
                                    <strong>Current Price:</strong> $${prediction.current_price.toFixed(2)}<br>
                                    <strong>Predicted Price:</strong> $${prediction.predicted_price.toFixed(2)}<br>
                                    <strong>Predicted Change:</strong> 
                                    <span class="${prediction.predicted_change_percent > 0 ? 'sentiment-positive' : 'sentiment-negative'}">
                                        ${prediction.predicted_change_percent.toFixed(2)}%
                                    </span><br>
                                    <strong>Average Sentiment:</strong> 
                                    <span class="${avgSentiment > 0 ? 'sentiment-positive' : 'sentiment-negative'}">
                                        ${avgSentiment.toFixed(2)}
                                    </span>
                                </p>
                            </div>
                        </div>
                    `;
                    detailedResults.appendChild(card);
                });
        }

        document.getElementById('startAnalysis').addEventListener('click', async () => {
            if (analysisInProgress) return;
            analysisInProgress = true;

            const button = document.getElementById('startAnalysis');
            button.disabled = true;
            button.textContent = 'Analysis in Progress...';

            document.getElementById('statusUpdates').innerHTML = '';
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Add initial status update
            addStatusUpdate('Initializing analysis...');
            updateProgress(5);

            let eventSource = null;

            try {
                // Start the analysis
                const response = await fetch('/run_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(error => {
                    console.error('Fetch error:', error);
                    throw new Error('Failed to connect to server. Please check if the server is running.');
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json().catch(error => {
                    console.error('JSON parse error:', error);
                    throw new Error('Failed to parse server response');
                });
                
                if (!data.queue_id) {
                    throw new Error('Invalid server response: missing queue ID');
                }

                const queue_id = data.queue_id;
                addStatusUpdate(`Analysis started with ID: ${queue_id}`);
                
                // Connect to SSE stream
                eventSource = new EventSource(`/status/${queue_id}`);
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.status) {
                            addStatusUpdate(data.status);
                        }
                        
                        if (data.progress !== undefined) {
                            updateProgress(data.progress);
                        }
                        
                        if (data.result) {
                            displayResults(data.result);
                            if (eventSource) {
                                eventSource.close();
                                eventSource = null;
                            }
                        }
                        
                        if (data.error) {
                            throw new Error(data.status);
                        }
                    } catch (error) {
                        console.error('Event processing error:', error);
                        addStatusUpdate(`Error processing update: ${error.message}`);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('EventSource error:', error);
                    addStatusUpdate('Connection to server lost. The analysis may still be running in the background.');
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                };
                
            } catch (error) {
                console.error('Overall error:', error);
                addStatusUpdate(`Error: ${error.message}`);
                updateProgress(100);
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            } finally {
                button.disabled = false;
                button.textContent = 'Start Market Analysis';
                analysisInProgress = false;
            }
        });
    </script>
</body>
</html>
