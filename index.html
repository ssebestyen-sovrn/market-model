<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market News Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
        }
        .header {
            background-color: #0d6efd;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .news-card {
            height: 100%;
        }
        .news-image {
            height: 180px;
            object-fit: cover;
        }
        .correlation-high {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
        }
        .correlation-medium {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }
        .correlation-low {
            background-color: rgba(108, 117, 125, 0.1);
            border-left: 4px solid #6c757d;
        }
        .prediction-up {
            color: #28a745;
        }
        .prediction-down {
            color: #dc3545;
        }
        .prediction-neutral {
            color: #6c757d;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #correlationChart, #predictionChart {
            max-height: 400px;
        }
        .ticker-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .ticker-up {
            background-color: #28a745;
        }
        .ticker-down {
            background-color: #dc3545;
        }
        .ticker-neutral {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingIndicator">
        <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing market data...</p>
        </div>
    </div>

    <div class="header">
        <div class="container">
            <h1 class="display-4">Market News Analyzer</h1>
            <p class="lead">Discover correlations between news stories and S&P 500 stock movements</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Market Analysis</h5>
                        <p class="card-text">Click the button below to analyze recent news stories and stock price movements for S&P 500 companies. The tool will identify correlations and make predictions for the next 24 hours.</p>
                        <button id="analyzeButton" class="btn btn-primary">Analyze Market Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsSection" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Correlation Analysis</h5>
                            <p class="card-text">Correlation between news sentiment and stock price movements</p>
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Price Movement Predictions</h5>
                            <p class="card-text">Predicted stock price movements for the next 24 hours</p>
                            <canvas id="predictionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="mb-3">Top Correlated News Stories</h3>
            <div id="newsContainer" class="row"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // S&P 500 tickers (abbreviated list for demo purposes)
        const sp500Tickers = [
            'AAPL', 'MSFT', 'AMZN', 'GOOGL', 'META', 'TSLA', 'NVDA', 'JPM', 'JNJ', 'V',
            'PG', 'UNH', 'HD', 'BAC', 'MA', 'XOM', 'DIS', 'CSCO', 'VZ', 'NFLX',
            'ADBE', 'CRM', 'INTC', 'PFE', 'KO', 'PEP', 'WMT', 'MRK', 'T', 'CMCSA'
        ];

        // NewsAPI key
        const newsApiKey = 'e713140ac78641bd91ad44b7ce192d76';
        
        // Financial data API (using Alpha Vantage for this example)
        const alphaVantageApiKey = 'demo'; // Replace with your actual API key for production

        // DOM elements
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsSection = document.getElementById('resultsSection');
        const newsContainer = document.getElementById('newsContainer');

        // Charts
        let correlationChart;
        let predictionChart;

        // Event listeners
        analyzeButton.addEventListener('click', startAnalysis);

        // Main analysis function
        async function startAnalysis() {
            try {
                // Show loading indicator
                loadingIndicator.style.display = 'flex';
                
                // Clear previous results
                newsContainer.innerHTML = '';
                
                // Fetch news data
                const newsData = await fetchNewsData();
                
                // Fetch stock data
                const stockData = await fetchStockData();
                
                // Analyze correlations
                const analysisResults = analyzeCorrelations(newsData, stockData);
                
                // Make predictions
                const predictions = makePredictions(analysisResults);
                
                // Display results
                displayResults(analysisResults, predictions);
                
                // Hide loading indicator and show results
                loadingIndicator.style.display = 'none';
                resultsSection.style.display = 'block';
            } catch (error) {
                console.error('Analysis failed:', error);
                alert('Analysis failed. Please try again later.');
                loadingIndicator.style.display = 'none';
            }
        }

        // Fetch news data from NewsAPI
        async function fetchNewsData() {
            // Calculate date for 48 hours ago
            const date = new Date();
            date.setHours(date.getHours() - 48);
            const fromDate = date.toISOString().split('T')[0];
            
            // Create search queries for each ticker
            const tickerPromises = sp500Tickers.map(ticker => {
                return fetch(`https://newsapi.org/v2/everything?q=${ticker}&from=${fromDate}&sortBy=publishedAt&apiKey=${newsApiKey}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            return {
                                ticker,
                                articles: data.articles.slice(0, 5) // Limit to 5 articles per ticker
                            };
                        }
                        return { ticker, articles: [] };
                    })
                    .catch(error => {
                        console.error(`Error fetching news for ${ticker}:`, error);
                        return { ticker, articles: [] };
                    });
            });
            
            // Wait for all requests to complete
            const results = await Promise.all(tickerPromises);
            
            // Flatten and process the results
            const processedNews = [];
            results.forEach(result => {
                result.articles.forEach(article => {
                    // Simple sentiment analysis based on title
                    const sentiment = analyzeSentiment(article.title);
                    
                    processedNews.push({
                        ticker: result.ticker,
                        title: article.title,
                        description: article.description,
                        url: article.url,
                        urlToImage: article.urlToImage,
                        publishedAt: article.publishedAt,
                        sentiment
                    });
                });
            });
            
            return processedNews;
        }

        // Simple sentiment analysis function
        function analyzeSentiment(text) {
            const positiveWords = ['up', 'rise', 'gain', 'positive', 'growth', 'profit', 'success', 'bullish', 'outperform', 'beat'];
            const negativeWords = ['down', 'fall', 'drop', 'negative', 'loss', 'decline', 'bearish', 'underperform', 'miss'];
            
            text = text.toLowerCase();
            
            let positiveScore = 0;
            let negativeScore = 0;
            
            positiveWords.forEach(word => {
                if (text.includes(word)) positiveScore++;
            });
            
            negativeWords.forEach(word => {
                if (text.includes(word)) negativeScore++;
            });
            
            if (positiveScore > negativeScore) return 'positive';
            if (negativeScore > positiveScore) return 'negative';
            return 'neutral';
        }

        // Fetch stock data
        async function fetchStockData() {
            // In a real application, you would use a financial API to get actual stock data
            // For this demo, we'll generate random data
            
            const stockData = {};
            
            sp500Tickers.forEach(ticker => {
                // Generate random price change between -5% and +5%
                const priceChange = (Math.random() * 10 - 5).toFixed(2);
                
                // Generate random price
                const currentPrice = (Math.random() * 500 + 50).toFixed(2);
                
                stockData[ticker] = {
                    ticker,
                    currentPrice: parseFloat(currentPrice),
                    priceChange: parseFloat(priceChange),
                    percentChange: parseFloat(priceChange)
                };
            });
            
            return stockData;
        }

        // Analyze correlations between news and stock movements
        function analyzeCorrelations(newsData, stockData) {
            const results = [];
            
            // Group news by ticker
            const newsByTicker = {};
            newsData.forEach(news => {
                if (!newsByTicker[news.ticker]) {
                    newsByTicker[news.ticker] = [];
                }
                newsByTicker[news.ticker].push(news);
            });
            
            // Calculate correlation for each ticker
            Object.keys(newsByTicker).forEach(ticker => {
                const tickerNews = newsByTicker[ticker];
                const tickerStock = stockData[ticker];
                
                if (!tickerStock) return;
                
                // Calculate average sentiment
                let positiveCount = 0;
                let negativeCount = 0;
                let neutralCount = 0;
                
                tickerNews.forEach(news => {
                    if (news.sentiment === 'positive') positiveCount++;
                    else if (news.sentiment === 'negative') negativeCount++;
                    else neutralCount++;
                });
                
                const totalNews = positiveCount + negativeCount + neutralCount;
                const sentimentScore = totalNews > 0 ? 
                    (positiveCount - negativeCount) / totalNews : 0;
                
                // Calculate correlation score
                // Simple approach: if sentiment and price change have the same sign, they're correlated
                const priceChangeSign = Math.sign(tickerStock.priceChange);
                const sentimentSign = Math.sign(sentimentScore);
                
                const correlationScore = priceChangeSign === sentimentSign ? 
                    Math.abs(sentimentScore * tickerStock.priceChange) : 
                    -Math.abs(sentimentScore * tickerStock.priceChange);
                
                // Determine correlation level
                let correlationLevel;
                if (Math.abs(correlationScore) > 0.3) correlationLevel = 'high';
                else if (Math.abs(correlationScore) > 0.1) correlationLevel = 'medium';
                else correlationLevel = 'low';
                
                results.push({
                    ticker,
                    news: tickerNews,
                    priceChange: tickerStock.priceChange,
                    currentPrice: tickerStock.currentPrice,
                    sentimentScore,
                    correlationScore,
                    correlationLevel
                });
            });
            
            // Sort by correlation score (absolute value)
            results.sort((a, b) => Math.abs(b.correlationScore) - Math.abs(a.correlationScore));
            
            return results;
        }

        // Make predictions based on correlations
        function makePredictions(analysisResults) {
            const predictions = [];
            
            analysisResults.forEach(result => {
                // Simple prediction model:
                // If correlation is high and positive, predict continued movement in same direction
                // If correlation is high and negative, predict reversal
                // If correlation is low, predict small movement
                
                let predictionDirection;
                let predictionStrength;
                
                if (Math.abs(result.correlationScore) > 0.3) {
                    // High correlation
                    if (result.correlationScore > 0) {
                        // Positive correlation - trend continues
                        predictionDirection = Math.sign(result.priceChange);
                        predictionStrength = 'strong';
                    } else {
                        // Negative correlation - trend reverses
                        predictionDirection = -Math.sign(result.priceChange);
                        predictionStrength = 'strong';
                    }
                } else if (Math.abs(result.correlationScore) > 0.1) {
                    // Medium correlation
                    if (result.correlationScore > 0) {
                        predictionDirection = Math.sign(result.priceChange);
                        predictionStrength = 'moderate';
                    } else {
                        predictionDirection = -Math.sign(result.priceChange);
                        predictionStrength = 'moderate';
                    }
                } else {
                    // Low correlation
                    predictionDirection = 0;
                    predictionStrength = 'weak';
                }
                
                // Calculate predicted price change
                let predictedChange;
                if (predictionStrength === 'strong') {
                    predictedChange = predictionDirection * (Math.random() * 3 + 2); // 2-5%
                } else if (predictionStrength === 'moderate') {
                    predictedChange = predictionDirection * (Math.random() * 2 + 1); // 1-3%
                } else {
                    predictedChange = predictionDirection * (Math.random() * 1); // 0-1%
                }
                
                predictions.push({
                    ticker: result.ticker,
                    currentPrice: result.currentPrice,
                    predictedChange: parseFloat(predictedChange.toFixed(2)),
                    predictedPrice: parseFloat((result.currentPrice * (1 + predictedChange / 100)).toFixed(2)),
                    predictionStrength
                });
            });
            
            return predictions;
        }

        // Display results in the UI
        function displayResults(analysisResults, predictions) {
            // Display correlation chart
            createCorrelationChart(analysisResults.slice(0, 10));
            
            // Display prediction chart
            createPredictionChart(predictions.slice(0, 10));
            
            // Display news cards
            displayNewsCards(analysisResults.slice(0, 9));
        }

        // Create correlation chart
        function createCorrelationChart(data) {
            const ctx = document.getElementById('correlationChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (correlationChart) correlationChart.destroy();
            
            // Prepare data
            const labels = data.map(item => item.ticker);
            const correlationData = data.map(item => item.correlationScore);
            const backgroundColors = correlationData.map(score => 
                score > 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)'
            );
            
            // Create chart
            correlationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Correlation Score',
                        data: correlationData,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Correlation Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ticker'
                            }
                        }
                    }
                }
            });
        }

        // Create prediction chart
        function createPredictionChart(data) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (predictionChart) predictionChart.destroy();
            
            // Prepare data
            const labels = data.map(item => item.ticker);
            const predictionData = data.map(item => item.predictedChange);
            const backgroundColors = predictionData.map(change => 
                change > 0 ? 'rgba(40, 167, 69, 0.6)' : 
                change < 0 ? 'rgba(220, 53, 69, 0.6)' : 'rgba(108, 117, 125, 0.6)'
            );
            
            // Create chart
            predictionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Predicted Change (%)',
                        data: predictionData,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Predicted Change (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ticker'
                            }
                        }
                    }
                }
            });
        }

        // Display news cards
        function displayNewsCards(results) {
            results.forEach(result => {
                // Get the most relevant news article
                const article = result.news[0];
                if (!article) return;
                
                // Create card element
                const cardCol = document.createElement('div');
                cardCol.className = 'col-md-4 mb-4';
                
                const card = document.createElement('div');
                card.className = `card news-card correlation-${result.correlationLevel}`;
                
                // Create card content
                let tickerBadgeClass = '';
                if (result.priceChange > 0) tickerBadgeClass = 'ticker-up';
                else if (result.priceChange < 0) tickerBadgeClass = 'ticker-down';
                else tickerBadgeClass = 'ticker-neutral';
                
                let predictionClass = '';
                const prediction = predictions.find(p => p.ticker === result.ticker);
                if (prediction) {
                    if (prediction.predictedChange > 0) predictionClass = 'prediction-up';
                    else if (prediction.predictedChange < 0) predictionClass = 'prediction-down';
                    else predictionClass = 'prediction-neutral';
                }
                
                card.innerHTML = `
                    <img src="${article.urlToImage || 'https://via.placeholder.com/300x180?text=No+Image'}" class="card-img-top news-image" alt="${article.title}">
                    <div class="card-body">
                        <h5 class="card-title">${article.title}</h5>
                        <p class="card-text">${article.description || 'No description available'}</p>
                        <div class="mb-2">
                            <span class="badge ${tickerBadgeClass}">${result.ticker}: ${result.priceChange > 0 ? '+' : ''}${result.priceChange}%</span>
                        </div>
                        <div class="mb-2">
                            <strong>Correlation:</strong> ${Math.abs(result.correlationScore).toFixed(2)} 
                            (${result.correlationScore > 0 ? 'Positive' : 'Negative'})
                        </div>
                        <div class="mb-2 ${predictionClass}">
                            <strong>Prediction:</strong> ${prediction ? (prediction.predictedChange > 0 ? '+' : '') + prediction.predictedChange + '%' : 'N/A'}
                        </div>
                        <a href="${article.url}" target="_blank" class="btn btn-primary btn-sm">Read More</a>
                    </div>
                `;
                
                // Add card to container
                cardCol.appendChild(card);
                newsContainer.appendChild(cardCol);
            });
        }
    </script>
</body>
</html>
