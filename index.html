<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
        }
        .status-container {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .results-container {
            display: none;
            margin-top: 2rem;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-update {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .ticker-card {
            margin-bottom: 1rem;
        }
        .sentiment-positive { color: #28a745; }
        .sentiment-negative { color: #dc3545; }
        .sentiment-neutral { color: #6c757d; }
        .api-url-container {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1 class="mb-4">Market Analysis Dashboard</h1>
        
        <div class="api-url-container">
            <div class="input-group mb-3">
                <span class="input-group-text">API Server URL</span>
                <input type="text" id="apiUrl" class="form-control" placeholder="Enter your API server URL (e.g., http://your-server:5000)" value="">
                <button class="btn btn-outline-secondary" type="button" id="testConnection">Test Connection</button>
            </div>
            <div class="form-text">Enter the URL of your backend API server. This should be the address where your Flask server is running.</div>
        </div>
        
        <div class="d-grid gap-2">
            <button id="startAnalysis" class="btn btn-primary btn-lg">
                Start Market Analysis
            </button>
        </div>

        <div id="statusContainer" class="status-container">
            <h3>Status Updates</h3>
            <div id="statusUpdates"></div>
            <div class="progress mt-3" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <div id="resultsContainer" class="results-container">
            <h3>Analysis Results</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4>Top Positive Sentiment Stocks</h4>
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4>Predicted Price Changes</h4>
                        <canvas id="predictionsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h4>Detailed Analysis</h4>
                <div id="detailedResults" class="row"></div>
            </div>
        </div>
    </div>

    <script>
        let analysisInProgress = false;
        let supabase = null;
        let pollingInterval = null;
        
        // Initialize Supabase client
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiUrl = localStorage.getItem('apiUrl');
            if (savedApiUrl) {
                document.getElementById('apiUrl').value = savedApiUrl;
            }
            
            // Check for Supabase credentials in URL (for development)
            const urlParams = new URLSearchParams(window.location.search);
            const supabaseUrl = urlParams.get('supabaseUrl');
            const supabaseKey = urlParams.get('supabaseKey');
            
            if (supabaseUrl && supabaseKey) {
                initializeSupabase(supabaseUrl, supabaseKey);
            }
        });
        
        function initializeSupabase(url, key) {
            try {
                supabase = supabase.createClient(url, key);
                addStatusUpdate(`✅ Supabase client initialized`);
                
                // Check if user is signed in
                checkAuthStatus();
            } catch (error) {
                console.error('Supabase initialization error:', error);
                addStatusUpdate(`❌ Failed to initialize Supabase: ${error.message}`);
            }
        }
        
        async function checkAuthStatus() {
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (data.session) {
                    addStatusUpdate(`✅ Signed in as: ${data.session.user.email}`);
                } else {
                    addStatusUpdate(`ℹ️ Not signed in. Please sign in to use the application.`);
                    // Show sign-in UI here
                }
            } catch (error) {
                console.error('Auth status error:', error);
                addStatusUpdate(`❌ Auth error: ${error.message}`);
            }
        }

        function addStatusUpdate(message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-update';
            statusDiv.textContent = message;
            document.getElementById('statusUpdates').appendChild(statusDiv);
        }

        function updateProgress(percent) {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${percent}%`;
            progressBar.parentElement.style.display = 'flex';
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.style.display = 'block';

            // Process correlations and predictions
            const correlations = data.analysis.correlations;
            const predictions = data.analysis.predictions;

            // Check if we have data to display
            if (Object.keys(correlations).length === 0 || Object.keys(predictions).length === 0) {
                addStatusUpdate("No analysis data available. This may be a simplified demo result.");
                return;
            }

            // Prepare data for sentiment chart
            const sentimentData = Object.entries(correlations)
                .map(([ticker, articles]) => ({
                    ticker,
                    avgSentiment: articles.reduce((sum, a) => sum + a.sentiment, 0) / articles.length
                }))
                .sort((a, b) => b.avgSentiment - a.avgSentiment)
                .slice(0, 10);

            // Create sentiment chart
            new Chart(document.getElementById('sentimentChart'), {
                type: 'bar',
                data: {
                    labels: sentimentData.map(d => d.ticker),
                    datasets: [{
                        label: 'Average Sentiment',
                        data: sentimentData.map(d => d.avgSentiment),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Prepare data for predictions chart
            const predictionsData = Object.entries(predictions)
                .map(([ticker, data]) => ({
                    ticker,
                    change: data.predicted_change_percent
                }))
                .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
                .slice(0, 10);

            // Create predictions chart
            new Chart(document.getElementById('predictionsChart'), {
                type: 'bar',
                data: {
                    labels: predictionsData.map(d => d.ticker),
                    datasets: [{
                        label: 'Predicted Change %',
                        data: predictionsData.map(d => d.change),
                        backgroundColor: d => d > 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Display detailed results
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = '';

            Object.entries(correlations)
                .filter(([ticker]) => predictions[ticker])
                .forEach(([ticker, articles]) => {
                    const prediction = predictions[ticker];
                    const avgSentiment = articles.reduce((sum, a) => sum + a.sentiment, 0) / articles.length;
                    
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 ticker-card';
                    card.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${ticker}</h5>
                                <p class="card-text">
                                    <strong>Current Price:</strong> $${prediction.current_price.toFixed(2)}<br>
                                    <strong>Predicted Price:</strong> $${prediction.predicted_price.toFixed(2)}<br>
                                    <strong>Predicted Change:</strong> 
                                    <span class="${prediction.predicted_change_percent > 0 ? 'sentiment-positive' : 'sentiment-negative'}">
                                        ${prediction.predicted_change_percent.toFixed(2)}%
                                    </span><br>
                                    <strong>Average Sentiment:</strong> 
                                    <span class="${avgSentiment > 0 ? 'sentiment-positive' : 'sentiment-negative'}">
                                        ${avgSentiment.toFixed(2)}
                                    </span>
                                </p>
                            </div>
                        </div>
                    `;
                    detailedResults.appendChild(card);
                });
        }

        // Test connection to Supabase
        document.getElementById('testConnection').addEventListener('click', async () => {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (!apiUrl) {
                addStatusUpdate('Please enter a Supabase URL');
                return;
            }
            
            // Parse the URL to extract Supabase URL and key
            try {
                // Format should be: https://your-project.supabase.co?key=your-anon-key
                const url = new URL(apiUrl);
                const supabaseUrl = url.origin;
                const supabaseKey = url.searchParams.get('key');
                
                if (!supabaseKey) {
                    addStatusUpdate('Please include the anon key in the URL as a query parameter: ?key=your-anon-key');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('apiUrl', apiUrl);
                
                addStatusUpdate(`Testing connection to Supabase at ${supabaseUrl}...`);
                
                // Initialize Supabase client
                initializeSupabase(supabaseUrl, supabaseKey);
                
                // Test connection by calling the health function
                try {
                    const { data, error } = await supabase.functions.invoke('health');
                    
                    if (error) {
                        throw error;
                    }
                    
                    addStatusUpdate(`✅ Connection successful! Server status: ${data.status}`);
                } catch (error) {
                    console.error('Function error:', error);
                    addStatusUpdate(`❌ Connection failed: ${error.message}`);
                    addStatusUpdate(`Make sure you've deployed the Edge Functions to your Supabase project.`);
                }
            } catch (error) {
                console.error('URL parsing error:', error);
                addStatusUpdate(`❌ Invalid URL format: ${error.message}`);
                addStatusUpdate(`URL should be in the format: https://your-project.supabase.co?key=your-anon-key`);
            }
        });

        document.getElementById('startAnalysis').addEventListener('click', async () => {
            if (analysisInProgress) return;
            
            if (!supabase) {
                addStatusUpdate('Please connect to Supabase first');
                return;
            }
            
            // Check if user is signed in
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                addStatusUpdate('Please sign in to run an analysis');
                return;
            }
            
            analysisInProgress = true;

            const button = document.getElementById('startAnalysis');
            button.disabled = true;
            button.textContent = 'Analysis in Progress...';

            document.getElementById('statusUpdates').innerHTML = '';
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Add initial status update
            addStatusUpdate('Initializing analysis...');
            updateProgress(5);

            try {
                // Call the run-analysis function
                const { data, error } = await supabase.functions.invoke('run-analysis');
                
                if (error) {
                    throw new Error(`Failed to start analysis: ${error.message}`);
                }
                
                if (!data || !data.analysis_id) {
                    throw new Error('Invalid response: missing analysis ID');
                }

                const analysisId = data.analysis_id;
                addStatusUpdate(`Analysis started with ID: ${analysisId}`);
                updateProgress(10);
                
                // Start polling for updates
                startPolling(analysisId);
                
            } catch (error) {
                console.error('Analysis error:', error);
                addStatusUpdate(`Error: ${error.message}`);
                updateProgress(100);
                button.disabled = false;
                button.textContent = 'Start Market Analysis';
                analysisInProgress = false;
            }
        });
        
        function startPolling(analysisId) {
            // Clear any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Poll every 2 seconds
            pollingInterval = setInterval(async () => {
                try {
                    const { data, error } = await supabase.functions.invoke('get-analysis', {
                        body: { id: analysisId }
                    });
                    
                    if (error) {
                        throw error;
                    }
                    
                    // Update progress
                    if (data.progress) {
                        updateProgress(data.progress);
                    }
                    
                    // Update status
                    if (data.status) {
                        addStatusUpdate(`Status: ${data.status}`);
                    }
                    
                    // Check if analysis is complete
                    if (data.status === 'completed' && data.results) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        
                        addStatusUpdate('Analysis complete!');
                        updateProgress(100);
                        
                        // Display results
                        displayResults(data.results);
                        
                        // Reset UI
                        document.getElementById('startAnalysis').disabled = false;
                        document.getElementById('startAnalysis').textContent = 'Start Market Analysis';
                        analysisInProgress = false;
                    }
                    
                    // Check if analysis failed
                    if (data.status === 'error') {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        
                        throw new Error(data.error_message || 'Analysis failed');
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    addStatusUpdate(`Error: ${error.message}`);
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    
                    document.getElementById('startAnalysis').disabled = false;
                    document.getElementById('startAnalysis').textContent = 'Start Market Analysis';
                    analysisInProgress = false;
                }
            }, 2000);
        }
    </script>
</body>
</html>
